@model AuthTest.Models.ChatConfig
@{
    ViewData["Title"] = "Home Page";
}

<style>
    html, body {
        height: 100%
    }

    body {
        margin: 0
    }

    #webchat {
        height: 100%;
        width: 100%;
    }
</style>

<div class="graph-token">Graph token goes here</div>
<div id="webchat" role="main" />
<script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!--Need bluebird for polyfilling promise in IE-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
<script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.js"></script>

<script>
    //AAD Application
    var clientApplication;

    (function () {
        var msalConfig = {
            auth: {
                clientId: '@Model.ClientId',
                authority: 'https://login.microsoftonline.com/@Model.TenantId'
            },
            cache: {
                cacheLocation: 'localStorage'
            }
        };
        let requestObj = {
            scopes: ["openid"]
        };

        if (!clientApplication) {
            clientApplication = new Msal.UserAgentApplication(msalConfig);
        }

        var $signInButton = $(".app-login");
        var $signOutButton = $(".app-logout");
        var $userDisplay = $(".app-user");

        //delete these (for demo purpose only)
        var $showGraphTokenButton = $(".app-show-graph");
        var $hideGraphTokenButton = $(".app-hide-graph");
        var $graphTokenDisplay = $(".graph-token");

        // Register NavBar Click Handlers
        $signOutButton.click(function () {
            clientApplication.logout();
        });

        $signInButton.click(function () {
            clientApplication.loginPopup(requestObj).then(onSignin).catch(function (error) {console.log(error) });
        });
        $showGraphTokenButton.click(function () {
            let user = clientApplication.getAccount();
            if (user) {
                let requestObj1 = {
                    scopes: ['openid']
                };
                clientApplication.acquireTokenSilent(requestObj1).then(function (tokenResponse) {
                    $showGraphTokenButton.hide();
                    $hideGraphTokenButton.show();
                    $graphTokenDisplay.html(tokenResponse.accessToken);
                    $graphTokenDisplay.show();

                });
            }
        });

        $hideGraphTokenButton.click(function () {
            $showGraphTokenButton.show();
            $hideGraphTokenButton.hide();
            $graphTokenDisplay.empty();
            $graphTokenDisplay.hide();
        });

        $hideGraphTokenButton.hide();
        $graphTokenDisplay.empty();
        $graphTokenDisplay.hide();


        //delete ends here
        let user1 = clientApplication.getAccount();
        if (user1) {
            $userDisplay.html(user1.name);
            $userDisplay.show();
            $signInButton.hide();
            $signOutButton.show();
        }
        else {
            $userDisplay.empty();
            $userDisplay.hide();
            $signInButton.show();
            $signOutButton.hide();
        }



        function onSignin(idToken) {
            // Check Login Status, Update UI
            let user = clientApplication.getAccount();
            if (user) {
                $userDisplay.html(user.name);
                $userDisplay.show();
                $signInButton.hide();
                $signOutButton.show();
            } else {
                $userDisplay.empty();
                $userDisplay.hide();
                $signInButton.show();
                $signOutButton.hide();
            }

        }

    }());

    function getOAuthCardResourceUri(activity) {
        if (activity &&
            activity.attachments &&
            activity.attachments[0] &&
            activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
            activity.attachments[0].content.tokenExchangeResource &&
            activity.attachments[0].content.tokenExchangeResource.providerId) {        // asking for token exchange with AAD
            return activity.attachments[0].content.tokenExchangeResource.uri;
        }
    }

    function exchangeTokenAsync(resourceUri) {
        // todo: token exchange
        // return a token if successful, nothing otherwise
        let user = clientApplication.getAccount();
        if (user) {
            let requestObj = {
                scopes: [resourceUri]
            };
            return clientApplication.acquireTokenSilent(requestObj)
                .then(function (tokenResponse) {
                    return tokenResponse.accessToken;
                })
                .catch(function (error) {
                    console.log(error);
                });

        }
        else {
            return Promise.resolve(null);
        }
        //else {
        //    return null;
        //}
        ////return 'clientExchangableToken12345';
        //return null;
    }

    const directLine = window.WebChat.createDirectLine({ token: '@Model.Token', domain: '@Model.Domain' });

    // We are creating the Web Chat store here so we can dispatch WEB_CHAT/SEND_MESSAGE action later.
    // We are adding a new middleware to customize the behavior of DIRECT_LINE/INCOMING_ACTIVITY.
    const store = window.WebChat.createStore(
        {},
        ({ dispatch }) => next => action => {
            if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                const activity = action.payload.activity;
                let resourceUri;
                if (activity.from && activity.from.role === 'bot' && (resourceUri = getOAuthCardResourceUri(activity))) {
                    exchangeTokenAsync(resourceUri).then(function (token) {

                        if (token) {
                            directLine.postActivity({
                                type: 'invoke',
                                name: 'signin/tokenExchange',
                                value: {
                                    id: activity.attachments[0].content.tokenExchangeResource.id,
                                    connectionName: activity.attachments[0].content.connectionName,
                                    token
                                }
                            }).subscribe(
                                id => {
                                    if (id === 'retry') {
                                        // bot was not able to handle the invoke, so display the oauthCard
                                        return next(action);
                                    }
                                    // else: token exchange was successful and we do not display the oauthCard
                                },
                                error => {
                                    // an error occurred to display the oauthCard
                                    return next(action);
                                }
                            );
                            return;
                        }
                        else
                            return next(action);
                    });
                }
                else
                    return next(action);
            }
            else
                return next(action);
        });

    window.WebChat.renderWebChat({
        directLine: directLine,
        store
    }, document.getElementById('webchat'));
</script>
